<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>StarChip Scanner</title>
<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="#04040a">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="apple-touch-icon" href="/icon-192.png">
<style>
  @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@400;600;700&family=Share+Tech+Mono&display=swap');
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    background: #04040a; color: #d8dce6;
    font-family: 'Rajdhani', -apple-system, sans-serif;
    min-height: 100vh; overflow-x: hidden;
  }

  /* ── STARFIELD ── */
  .starfield { position: fixed; inset: 0; z-index: 0; pointer-events: none; overflow: hidden; }
  .star { position: absolute; border-radius: 50%; background: #fff; }
  .asteroid { position: absolute; border-radius: 30% 70% 50% 50%; opacity: 0.06; transform: rotate(var(--rot)); }
  @keyframes twinkle { 0%,100%{opacity:var(--base-o)} 50%{opacity:var(--peak-o)} }
  @keyframes drift { 0%{transform:translate(0,0) rotate(var(--rot))} 100%{transform:translate(var(--dx),var(--dy)) rotate(calc(var(--rot)+20deg))} }

  .screen {
    display: none; flex-direction: column; align-items: center;
    padding: 24px; min-height: 100vh; position: relative; z-index: 1;
  }
  .screen.active { display: flex; }

  /* ── JOIN SCREEN ── */
  .logo {
    font-family: 'Orbitron', sans-serif;
    font-size: 26px; font-weight: 900; letter-spacing: 3px; color: #fff;
    margin-top: 60px; text-shadow: 0 0 30px rgba(0,232,123,0.15);
  }
  .logo span { color: #00e87b; text-shadow: 0 0 20px rgba(0,232,123,0.3); }
  .subtitle {
    font-family: 'Orbitron', sans-serif;
    font-size: 11px; letter-spacing: 5px; color: #00e87b; opacity: 0.5;
    margin: 6px 0 48px;
  }

  .join-label {
    font-family: 'Orbitron', sans-serif;
    font-size: 10px; letter-spacing: 4px; color: rgba(255,255,255,0.25); margin-bottom: 12px;
  }
  .code-input {
    background: rgba(255,255,255,0.03); backdrop-filter: blur(8px);
    border: 1px solid rgba(255,255,255,0.08); border-radius: 12px;
    color: #fff; font-family: 'Orbitron', sans-serif;
    font-size: 30px; font-weight: 900; letter-spacing: 12px;
    text-align: center; padding: 16px 24px; width: 260px;
    text-transform: uppercase; outline: none; transition: border-color 0.3s;
  }
  .code-input:focus { border-color: rgba(0,232,123,0.4); }
  .code-input::placeholder { color: rgba(255,255,255,0.1); letter-spacing: 12px; }

  .name-input {
    background: rgba(255,255,255,0.03); backdrop-filter: blur(8px);
    border: 1px solid rgba(255,255,255,0.08); border-radius: 10px;
    color: #fff; font-family: 'Rajdhani', sans-serif;
    font-size: 16px; text-align: center; padding: 12px 20px;
    width: 260px; outline: none; margin-top: 14px; transition: border-color 0.3s;
  }
  .name-input:focus { border-color: rgba(0,232,123,0.4); }
  .name-input::placeholder { color: rgba(255,255,255,0.15); }

  .join-btn {
    font-family: 'Orbitron', sans-serif;
    background: rgba(0,232,123,0.15); color: #00e87b;
    border: 1px solid rgba(0,232,123,0.3); border-radius: 12px;
    font-size: 14px; font-weight: 700; letter-spacing: 3px; padding: 16px 48px;
    margin-top: 24px; cursor: pointer; transition: all 0.3s;
  }
  .join-btn:hover { background: rgba(0,232,123,0.25); border-color: rgba(0,232,123,0.5); }
  .join-btn:disabled {
    background: rgba(255,255,255,0.02); color: rgba(255,255,255,0.15);
    border-color: rgba(255,255,255,0.05); cursor: not-allowed;
  }
  .error-msg { color: #ff6666; font-size: 13px; margin-top: 12px; min-height: 20px; }

  /* ── SCANNER SCREEN ── */
  .scanner-header {
    display: flex; align-items: center; justify-content: space-between;
    width: 100%; padding: 8px 0; margin-bottom: 16px;
  }
  .room-badge {
    font-family: 'Orbitron', sans-serif;
    background: rgba(0,232,123,0.08); border: 1px solid rgba(0,232,123,0.2);
    border-radius: 8px; padding: 6px 14px; font-size: 12px; font-weight: 700;
    letter-spacing: 4px; color: #00e87b;
    text-shadow: 0 0 10px rgba(0,232,123,0.3);
  }
  .player-name { font-size: 14px; color: rgba(255,255,255,0.3); }

  .camera-wrap {
    position: relative; width: 100%; max-width: 340px;
    aspect-ratio: 1; border-radius: 16px; overflow: hidden;
    border: 1px solid rgba(255,255,255,0.08); background: #000;
    box-shadow: 0 0 40px rgba(0,0,0,0.5);
  }
  .camera-wrap video { width: 100%; height: 100%; object-fit: cover; }
  .camera-wrap canvas { display: none; }

  .scan-overlay {
    position: absolute; inset: 0; display: flex; align-items: center; justify-content: center;
    pointer-events: none;
  }
  .scan-reticle {
    width: 60%; height: 60%;
    border: 1px solid rgba(0,232,123,0.3); border-radius: 8px;
    position: relative;
    box-shadow: 0 0 20px rgba(0,232,123,0.05);
  }
  .scan-reticle::before, .scan-reticle::after {
    content: ''; position: absolute; background: rgba(0,232,123,0.6);
  }
  .scan-reticle::before { width: 20px; height: 1px; top: 50%; left: 50%; transform: translate(-50%,-50%); }
  .scan-reticle::after { width: 1px; height: 20px; top: 50%; left: 50%; transform: translate(-50%,-50%); }

  .scan-status {
    font-size: 13px; color: rgba(255,255,255,0.3); margin-top: 16px; letter-spacing: 1px;
    text-align: center; min-height: 20px;
  }
  .scan-status.success { color: #00e87b; text-shadow: 0 0 10px rgba(0,232,123,0.3); }

  .scanned-list { width: 100%; max-width: 340px; margin-top: 20px; }
  .scanned-list h3 {
    font-family: 'Orbitron', sans-serif;
    font-size: 10px; letter-spacing: 4px; color: rgba(255,255,255,0.25); margin-bottom: 10px;
  }
  .ship-card {
    display: flex; align-items: center; gap: 12px;
    background: rgba(255,255,255,0.025); backdrop-filter: blur(8px);
    border: 1px solid rgba(255,255,255,0.05); border-radius: 10px;
    padding: 10px 14px; margin-bottom: 8px;
    animation: slideIn 0.3s ease;
  }
  @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } }
  .ship-card-icon { width: 36px; height: 36px; flex-shrink: 0; }
  .ship-card-info { flex: 1; }
  .ship-card-name {
    font-family: 'Orbitron', sans-serif;
    font-size: 11px; font-weight: 700; letter-spacing: 1px;
  }
  .ship-card-detail { font-size: 11px; color: rgba(255,255,255,0.3); letter-spacing: 1px; margin-top: 2px; }
  .ship-card-remove {
    background: none; border: none; color: rgba(255,68,68,0.4); font-size: 18px;
    cursor: pointer; padding: 4px 8px; transition: color 0.2s;
  }
  .ship-card-remove:hover { color: #ff4444; }

  /* ── MATCH SCREEN ── */
  .match-status {
    font-family: 'Orbitron', sans-serif;
    font-size: 18px; font-weight: 900; color: #00e87b; letter-spacing: 4px;
    margin-top: 80px; text-shadow: 0 0 30px rgba(0,232,123,0.3);
  }
  .match-msg { font-size: 14px; color: rgba(255,255,255,0.2); margin-top: 12px; }
  .pulse { animation: pulse 2s ease-in-out infinite; }
  @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.3} }

  /* ── SAVED FLEET ── */
  .saved-fleet { width: 100%; max-width: 340px; margin-top: 28px; }
  .saved-fleet h3 {
    font-family: 'Orbitron', sans-serif;
    font-size: 10px; letter-spacing: 4px; color: rgba(255,255,255,0.25); margin-bottom: 10px;
    display: flex; align-items: center; gap: 10px;
  }
  .tap-hint {
    font-family: 'Rajdhani', sans-serif;
    font-size: 11px; color: rgba(0,232,123,0.3); letter-spacing: 1px; font-weight: 400;
  }
  .saved-ship-card {
    display: flex; align-items: center; gap: 12px;
    background: rgba(255,255,255,0.015); backdrop-filter: blur(8px);
    border: 1px solid rgba(255,255,255,0.04); border-radius: 10px;
    padding: 10px 14px; margin-bottom: 8px; cursor: pointer; transition: all 0.2s;
  }
  .saved-ship-card:hover, .saved-ship-card:active {
    border-color: rgba(0,232,123,0.2); background: rgba(0,232,123,0.03);
  }
  .saved-ship-card.added {
    border-color: rgba(0,232,123,0.3); background: rgba(0,232,123,0.06);
  }
  .saved-ship-card .add-icon {
    font-size: 16px; color: rgba(0,232,123,0.4); flex-shrink: 0; width: 24px; text-align: center;
  }
</style>
</head>
<body>

<div class="starfield" id="starfield"></div>

<!-- ═══ JOIN ═══ -->
<div class="screen active" id="joinScreen">
  <div class="logo">STAR<span>CHIP</span></div>
  <div class="subtitle">SCANNER</div>
  <div class="join-label">ENTER ROOM CODE</div>
  <input class="code-input" id="codeInput" type="text" maxlength="5" placeholder="····" autocomplete="off" autocorrect="off" spellcheck="false">
  <input class="name-input" id="nameInput" type="text" placeholder="Your name" maxlength="16" autocomplete="off">
  <button class="join-btn" id="joinBtn">JOIN ARENA</button>
  <div class="error-msg" id="errorMsg"></div>
</div>

<!-- ═══ SCANNER ═══ -->
<div class="screen" id="scanScreen">
  <div class="scanner-header">
    <div class="room-badge" id="roomBadge">----</div>
    <div class="player-name" id="playerNameDisplay"></div>
  </div>
  <div class="camera-wrap">
    <video id="video" autoplay playsinline></video>
    <canvas id="scanCanvas"></canvas>
    <div class="scan-overlay"><div class="scan-reticle"></div></div>
  </div>
  <div class="scan-status" id="scanStatus">Point camera at a StarChip QR code</div>
  <div class="scanned-list">
    <h3>YOUR FLEET (<span id="shipCount">0</span>)</h3>
    <div id="shipList"></div>
  </div>

  <div class="saved-fleet" id="savedFleetSection" style="display:none">
    <h3>SAVED STARCHIPS <span class="tap-hint">tap to enter</span></h3>
    <div id="savedFleetList"></div>
  </div>
</div>

<!-- ═══ MATCH ═══ -->
<div class="screen" id="matchScreen">
  <div class="logo">STAR<span>CHIP</span></div>
  <div class="match-status pulse">MATCH IN PROGRESS</div>
  <div class="match-msg">Watch the arena screen!</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
<script>
// ── NAMEGEN (inlined) ──
// ═══════════════════════════════════════════════════════════════
// STARCHIP PROCEDURAL NAME GENERATOR
// Edit the word pools below to customize ship names!
//
// Shapes & Colors & Temperaments: indexed 0–15
// Weapons, Passives, Maneuvers: keyed by string (e.g. 'shotgun')
//
// The generator picks 1 adjective from one trait's pool
// + 1 noun from a different trait's pool.
// Same card stats always produce the same name (seeded RNG).
// ═══════════════════════════════════════════════════════════════

const SHIP_NAME_BANK = {

  // ─── SHAPES (design index 0–15) ───────────────────────────
  shape: [
    // 0: FIGHTER
    { adj: ['Battle','Valiant','Militant','Warborn','Armed','Combat','Defiant','Iron'],
      noun: ['Warrior','Centurion','Gladiator','Champion','Vanguard','Sentinel','Warden','Soldier'] },
    // 1: LEAF
    { adj: ['Verdant','Organic','Living','Budding','Wild','Natural','Rooted','Floral'],
      noun: ['Sapling','Thorn','Petal','Blossom','Sprout','Bramble','Fern','Ivy'] },
    // 2: BOMBER
    { adj: ['Heavy','Explosive','Rumbling','Massive','Hulking','Loaded','Booming','Dense'],
      noun: ['Payload','Ordnance','Demolisher','Crater','Bombard','Warhead','Siege','Arsenal'] },
    // 3: ARROW
    { adj: ['Swift','Piercing','Sleek','Keen','Streaking','Darting','Fleet','Sharp'],
      noun: ['Bolt','Javelin','Quarrel','Spear','Dart','Lance','Needle','Shaft'] },
    // 4: HEART
    { adj: ['Blazing','Burning','Pulsing','Vital','Fierce','Passionate','Driven','Brave'],
      noun: ['Ember','Core','Flame','Spark','Pulse','Beacon','Forge','Crucible'] },
    // 5: JET
    { adj: ['Sonic','Roaring','Supersonic','Screaming','Afterburn','Turbo','Express','Mach'],
      noun: ['Comet','Streak','Contrail','Burner','Throttle','Afterglow','Turbine','Thruster'] },
    // 6: MONSTER
    { adj: ['Fearsome','Monstrous','Savage','Feral','Ravenous','Primal','Bestial','Dread'],
      noun: ['Behemoth','Leviathan','Titan','Hydra','Chimera','Kraken','Goliath','Wyrm'] },
    // 7: EDGE
    { adj: ['Angular','Serrated','Jagged','Bladed','Honed','Cutting','Edged','Whetted'],
      noun: ['Shard','Blade','Razor','Cleaver','Scalpel','Wedge','Splinter','Barb'] },
    // 8: GHOST
    { adj: ['Spectral','Phantom','Hollow','Haunted','Ethereal','Fading','Silent','Unseen'],
      noun: ['Wraith','Specter','Phantom','Shade','Apparition','Revenant','Banshee','Wisp'] },
    // 9: POINT
    { adj: ['Precise','Focused','Pinpoint','Acute','Narrow','Exact','Fine','Tipped'],
      noun: ['Spire','Apex','Vertex','Needle','Spike','Pinnacle','Stiletto','Prong'] },
    // 10: TWISTER
    { adj: ['Spinning','Spiraling','Whirling','Cyclonic','Rotating','Twisted','Gyrating','Coiling'],
      noun: ['Vortex','Tornado','Maelstrom','Spiral','Cyclone','Tempest','Whirlwind','Funnel'] },
    // 11: SURVIVOR
    { adj: ['Enduring','Resilient','Hardened','Scarred','Tested','Unbroken','Gritty','Tenacious'],
      noun: ['Remnant','Holdout','Bastion','Bulwark','Anchor','Pillar','Relic','Veteran'] },
    // 12: HAWK
    { adj: ['Predatory','Soaring','Keen-Eyed','Swooping','Raptor','Hunting','Taloned','Circling'],
      noun: ['Falcon','Raptor','Talon','Eagle','Osprey','Harrier','Kestrel','Merlin'] },
    // 13: FRIGATE
    { adj: ['Imposing','Naval','Broadside','Armored','Seafaring','Flagship','Decked','Gallant'],
      noun: ['Frigate','Dreadnought','Corvette','Galleon','Cruiser','Destroyer','Brigantine','Armada'] },
    // 14: CRESCENT
    { adj: ['Lunar','Curved','Waning','Arcing','Crescent','Horned','Bowed','Sweeping'],
      noun: ['Eclipse','Moonrise','Crescent','Scythe','Sickle','Arc','Halo','Corona'] },
    // 15: ENFORCER
    { adj: ['Ruthless','Unyielding','Stern','Ironclad','Formidable','Commanding','Absolute','Rigid'],
      noun: ['Marshal','Enforcer','Arbiter','Warden','Judge','Inquisitor','Constable','Regent'] },
  ],

  // ─── COLORS (color index 0–15) ────────────────────────────
  color: [
    // 0: RED
    { adj: ['Crimson','Scarlet','Bloodied','Ruby','Infernal','Smoldering','Molten','Searing'],
      noun: ['Inferno','Blaze','Furnace','Magma','Cinder','Volcano','Pyre','Flare'] },
    // 1: GREEN
    { adj: ['Emerald','Verdant','Mossy','Jade','Lush','Overgrown','Toxic','Jungle'],
      noun: ['Canopy','Thicket','Grove','Moss','Jungle','Glade','Marsh','Vine'] },
    // 2: BLUE
    { adj: ['Cobalt','Azure','Glacial','Deep','Oceanic','Frozen','Cerulean','Sapphire'],
      noun: ['Abyss','Glacier','Depths','Tide','Frost','Riptide','Iceberg','Current'] },
    // 3: ORANGE
    { adj: ['Amber','Smoldering','Russet','Copper','Autumn','Harvest','Scorched','Tawny'],
      noun: ['Sunset','Bonfire','Hearth','Lantern','Campfire','Ember','Kiln','Dusk'] },
    // 4: PINK
    { adj: ['Rosy','Blushing','Coral','Flushed','Dawn','Pastel','Vibrant','Neon'],
      noun: ['Aurora','Bloom','Blush','Petal','Dawn','Rosette','Orchid','Dahlia'] },
    // 5: CYAN
    { adj: ['Electric','Frigid','Aqua','Neon','Shimmering','Teal','Luminous','Glinting'],
      noun: ['Circuit','Current','Plasma','Signal','Conduit','Filament','Prism','Relay'] },
    // 6: LIME
    { adj: ['Acid','Caustic','Toxic','Venomous','Corrosive','Volatile','Reactive','Bitter'],
      noun: ['Catalyst','Toxin','Reagent','Venom','Acid','Enzyme','Solvent','Compound'] },
    // 7: CORAL
    { adj: ['Warm','Tropical','Sunlit','Coastal','Radiant','Glowing','Burnished','Balmy'],
      noun: ['Lagoon','Reef','Atoll','Shoal','Tideway','Grotto','Cove','Sandbar'] },
    // 8: PURPLE
    { adj: ['Royal','Mystic','Regal','Arcane','Imperial','Sovereign','Ancient','Noble'],
      noun: ['Throne','Crown','Scepter','Monarch','Dynasty','Dominion','Empire','Sanctum'] },
    // 9: WHITE
    { adj: ['Pale','Blinding','Pristine','Stark','Pure','Radiant','Bleached','Ivory'],
      noun: ['Haze','Zenith','Void','Blank','Frost','Glare','Bone','Chalk'] },
    // 10: YELLOW
    { adj: ['Solar','Blazing','Golden','Sizzling','Brilliant','Luminous','Flashing','Dazzling'],
      noun: ['Sunburst','Lightning','Flash','Flicker','Spark','Ray','Beam','Photon'] },
    // 11: MAGENTA
    { adj: ['Vivid','Exotic','Intense','Fluorescent','Lurid','Fierce','Pulsing','Ultraviolet'],
      noun: ['Prism','Anomaly','Mirage','Illusion','Paradox','Enigma','Glitch','Rift'] },
    // 12: SKY
    { adj: ['Soaring','Aerial','Boundless','Cloudborn','Windswept','Drifting','Open','High'],
      noun: ['Horizon','Stratosphere','Gust','Zephyr','Altitude','Updraft','Breeze','Summit'] },
    // 13: GOLD
    { adj: ['Gilded','Precious','Lustrous','Opulent','Gleaming','Resplendent','Ornate','Regal'],
      noun: ['Treasure','Bullion','Ingot','Doubloon','Sovereign','Fortune','Hoard','Tribute'] },
    // 14: SILVER
    { adj: ['Chrome','Quicksilver','Polished','Mercurial','Tempered','Sterling','Bright','Mirrored'],
      noun: ['Mercury','Mirror','Alloy','Nickel','Steel','Tinsel','Plate','Edge'] },
    // 15: VIOLET
    { adj: ['Twilight','Shadowed','Dusky','Deep','Crepuscular','Amethyst','Midnight','Nebular'],
      noun: ['Nebula','Dusk','Twilight','Shadow','Nightfall','Eventide','Umbra','Gloaming'] },
  ],

  // ─── WEAPONS (19 — keyed by WEAPON_DEFS key) ─────────────
  weapon: {
    basic:        { adj: ['Steady','Reliable','Standard','Proven','Trusted','Classic','Veteran','Stock'],          noun: ['Standard','Sidearm','Workhorse','Staple','Mainline','Baseline','Foundation','Bedrock'] },
    shotgun:      { adj: ['Buckshot','Scattergun','Close-Range','Boomstick','Wide','Pelting','Thundering','Blasting'], noun: ['Scatter','Buckshot','Slug','Shredder','Boomstick','Pelter','Ripper','Buster'] },
    grenade:      { adj: ['Explosive','Detonating','Fragmenting','Shrapnel','Bursting','Incendiary','Volatile','Cluster'], noun: ['Grenade','Mortar','Shell','Mine','Bomblet','Fragment','Canister','Shrapnel'] },
    triple:       { adj: ['Triple','Three-Barreled','Tri-Fire','Spreading','Fanning','Multi-Shot','Widening','Broad'], noun: ['Trident','Trifecta','Trilogy','Triplet','Trio','Triumvirate','Triangle','Treble'] },
    homing:       { adj: ['Tracking','Seeking','Locked','Guided','Pursuing','Homing','Stalking','Targeting'],     noun: ['Missile','Seeker','Hunter','Interceptor','Tracker','Predator','Stalker','Pursuer'] },
    alternating:  { adj: ['Twin','Dual','Paired','Double','Mirrored','Parallel','Coupled','Tandem'],              noun: ['Barrage','Volley','Salvo','Broadside','Cascade','Battery','Fusillade','Crossfire'] },
    flamethrower: { adj: ['Scorching','Blazing','Hellfire','Searing','Charring','Napalm','Blistering','White-Hot'], noun: ['Dragon','Inferno','Hellfire','Firestorm','Immolation','Blaze','Conflagration','Furnace'] },
    sniper:       { adj: ['Distant','Marksman','Telescopic','Long-Range','Silent','Patient','Lethal','Clinical'],  noun: ['Marksman','Sharpshooter','Longshot','Deadeye','Crosshair','Scope','Bullseye','Caliber'] },
    chaotic:      { adj: ['Chaotic','Erratic','Unhinged','Frenzied','Random','Scrambled','Turbulent','Glitched'], noun: ['Havoc','Chaos','Mayhem','Frenzy','Scramble','Disorder','Pandemonium','Entropy'] },
    scrap:        { adj: ['Jagged','Junked','Cobbled','Makeshift','Salvaged','Patchwork','Rusty','Improvised'],    noun: ['Junkyard','Scrapheap','Wreckage','Salvage','Debris','Shrapnel','Rubble','Refuse'] },
    snake:        { adj: ['Serpentine','Slithering','Winding','Coiling','Viper','Fanged','Venomous','Sinuous'],    noun: ['Serpent','Viper','Cobra','Sidewinder','Mamba','Asp','Fang','Python'] },
    gatling:      { adj: ['Relentless','Drumming','Unceasing','Hammering','Grinding','Rattling','Chattering','Pelting'], noun: ['Gatling','Minigun','Chaingun','Turret','Hailstorm','Buzzsaw','Jackhammer','Grinder'] },
    boomerang:    { adj: ['Returning','Curved','Arcing','Looping','Sweeping','Orbiting','Recurving','Hooking'],    noun: ['Boomerang','Arc','Hook','Return','Orbit','Curveball','Sling','Ricochet'] },
    doublehelix:  { adj: ['Helical','Twisting','Intertwined','Spiraling','Braided','Weaving','Entwined','Woven'], noun: ['Helix','Strand','Spiral','Braid','Weave','Double','Corkscrew','Twist'] },
    cyclone:      { adj: ['Whirling','Storming','Gusting','Howling','Raging','Swirling','Blustering','Churning'], noun: ['Gale','Typhoon','Hurricane','Squall','Monsoon','Twister','Dustdevil','Sirocco'] },
    crossshot:    { adj: ['Converging','Crossing','Flanking','Pincer','Intersecting','Angled','Bracketing','Opposing'], noun: ['Crossfire','Pincer','Scissors','Intersect','Junction','Nexus','Vertex','Crux'] },
    lightning:    { adj: ['Voltaic','Crackling','Thunderous','Arcing','Surging','Galvanic','Shocking','Charged'],  noun: ['Thunder','Bolt','Shock','Surge','Arc','Jolt','Discharge','Capacitor'] },
    concussive:   { adj: ['Concussive','Shattering','Rupturing','Fracturing','Splintering','Cracking','Quaking','Rending'], noun: ['Shockwave','Impact','Tremor','Rupture','Fracture','Quake','Breaker','Rift'] },
    drone:        { adj: ['Swarming','Autonomous','Networked','Buzzing','Droning','Orbiting','Hovering','Linked'], noun: ['Swarm','Hive','Fleet','Cluster','Brood','Colony','Network','Array'] },
  },

  // ─── PASSIVES (25 — keyed by PASSIVE_DEFS key) ───────────
  passive: {
    scrapRepair:  { adj: ['Patched','Welded','Riveted','Hammered','Bolted','Mended','Scavenged','Reinforced'],    noun: ['Patchwork','Scrapyard','Weld','Rivet','Salvage','Repair','Tinker','Anvil'] },
    bioHull:      { adj: ['Regenerating','Organic','Symbiotic','Adaptive','Growing','Mutating','Healing','Evolving'], noun: ['Organism','Symbiont','Parasite','Colony','Growth','Mutation','Membrane','Cocoon'] },
    nitro:        { adj: ['Boosted','Supercharged','Nitrous','Turbocharged','Afterburning','Redlining','Injected','Ramjet'], noun: ['Rocket','Booster','Dragster','Nitro','Overdrive','Accelerant','Propellant','Thrust'] },
    gyro:         { adj: ['Stabilized','Balanced','Centered','Calibrated','Steady','Level','Tuned','Aligned'],     noun: ['Gyroscope','Compass','Pendulum','Balance','Fulcrum','Axis','Stabilizer','Equilibrium'] },
    shield:       { adj: ['Shielded','Fortified','Armored','Protected','Guarded','Warded','Plated','Reinforced'],  noun: ['Shield','Barrier','Rampart','Aegis','Buckler','Phalanx','Fortress','Citadel'] },
    piercing:     { adj: ['Piercing','Penetrating','Perforating','Punching','Impaling','Skewering','Lancing','Boring'], noun: ['Harpoon','Lancet','Rapier','Stiletto','Awl','Spike','Skewer','Impaler'] },
    fierce:       { adj: ['Fierce','Ferocious','Vicious','Brutal','Savage','Ruthless','Wrathful','Furious'],       noun: ['Fury','Wrath','Rage','Carnage','Havoc','Slaughter','Rampage','Onslaught'] },
    hitInvuln:    { adj: ['Phasing','Dimensional','Displaced','Shifting','Warping','Flickering','Temporal','Unstable'], noun: ['Phase','Dimension','Rift','Warp','Shift','Blink','Flicker','Glitch'] },
    scope:        { adj: ['Far-Seeing','Eagle-Eyed','Watchful','Vigilant','Hawkeyed','Scoped','Magnified','Scanning'], noun: ['Outlook','Vista','Lookout','Perch','Watchtower','Observatory','Spyglass','Sentry'] },
    titanium:     { adj: ['Titanium','Hardened','Tempered','Annealed','Forged','Plated','Dense','Alloyed'],        noun: ['Anvil','Ingot','Plate','Alloy','Carbide','Tungsten','Bastion','Bulkhead'] },
    stealth:      { adj: ['Hidden','Cloaked','Invisible','Lurking','Masked','Covert','Stealthy','Shrouded'],       noun: ['Shadow','Phantom','Ghost','Specter','Cloak','Veil','Mirage','Shroud'] },
    sparkDrive:   { adj: ['Sparking','Energized','Supercharged','Amped','Wired','Overclocked','Powered','Igniting'], noun: ['Dynamo','Generator','Spark','Capacitor','Amplifier','Transformer','Reactor','Coil'] },
    drillbore:    { adj: ['Boring','Drilling','Tunneling','Grinding','Burrowing','Excavating','Penetrating','Gouging'], noun: ['Auger','Drill','Borer','Excavator','Tunneler','Grinder','Digger','Piercer'] },
    iceRounds:    { adj: ['Frozen','Icy','Subzero','Glacial','Frosted','Frigid','Arctic','Bitter'],               noun: ['Avalanche','Blizzard','Permafrost','Icicle','Snowdrift','Hailstone','Tundra','Frostbite'] },
    jamRounds:    { adj: ['Jamming','Disrupting','Interfering','Scrambling','Garbling','Blocking','Fouling','Clogging'], noun: ['Jammer','Scrambler','Disruptor','Interference','Static','Noise','Blocker','Dampener'] },
    incendiary:   { adj: ['Burning','Smoldering','Fiery','Ashen','Charred','Flaming','Fuming','Ignited'],         noun: ['Wildfire','Cinderstorm','Ashfall','Burnout','Brushfire','Firebrand','Blister','Scorch'] },
    obliterator:  { adj: ['Obliterating','Annihilating','Devastating','Ruinous','Cataclysmic','Apocalyptic','Dooming','Ravaging'], noun: ['Oblivion','Annihilation','Devastation','Ruin','Cataclysm','Apocalypse','Doomsday','Extinction'] },
    absorber:     { adj: ['Consuming','Devouring','Draining','Hungering','Absorbing','Nullifying','Voracious','Ravenous'], noun: ['Abyss','Maw','Void','Singularity','Vacuum','Siphon','Drain','Nullifier'] },
    detonator:    { adj: ['Detonating','Volatile','Unstable','Triggered','Primed','Armed','Ticking','Hair-Trigger'], noun: ['Detonator','Bomb','Charge','Primer','Fuse','Trigger','Payload','Ignition'] },
    stunShock:    { adj: ['Stunning','Paralyzing','Numbing','Freezing','Locking','Seizing','Binding','Disabling'], noun: ['Stun','Paralysis','Lockdown','Seizure','Freeze','Gridlock','Clamp','Snare'] },
    override:     { adj: ['Hijacked','Overridden','Corrupted','Hacked','Subverted','Infected','Compromised','Breached'], noun: ['Virus','Exploit','Malware','Backdoor','Rootkit','Trojan','Worm','Override'] },
    cryoCoolant:  { adj: ['Rapid-Cycling','Quick-Loading','Fast-Chambered','Oiled','Greased','Streamlined','Efficient','Smooth'], noun: ['Piston','Cylinder','Crankshaft','Flywheel','Camshaft','Clockwork','Mechanism','Engine'] },
    flagship:     { adj: ['Grand','Towering','Mighty','Colossal','Supreme','Capital','Paramount','Monumental'],    noun: ['Flagship','Colossus','Titan','Juggernaut','Dreadnought','Mammoth','Fortress','Monument'] },
    blindRounds:  { adj: ['Blinding','Dazzling','Glaring','Flashing','Searing','Brilliant','Strobing','Radiant'], noun: ['Flashbang','Glare','Strobe','Flare','Blindside','Whiteout','Sunspot','Starburst'] },
    bouncyShot:   { adj: ['Ricocheting','Bouncing','Deflecting','Rebounding','Caroming','Skipping','Glancing','Angled'], noun: ['Ricochet','Bounce','Rebound','Carom','Deflection','Pinball','Billiard','Springback'] },
  },

  // ─── MANEUVERS (16 — keyed by MANEUVER_DEFS key) ─────────
  maneuver: {
    hyperSpeed:       { adj: ['Warping','Lightspeed','Hypersonic','Blurring','Teleporting','Phasing','Vanishing','Instant'], noun: ['Warp','Hyperspace','Lightspeed','Flash','Blink','Jump','Leap','Streak'] },
    barrelRoll:       { adj: ['Rolling','Acrobatic','Tumbling','Looping','Aerobatic','Nimble','Flipping','Deft'],  noun: ['Barrel','Roll','Loop','Corkscrew','Tumble','Somersault','Cartwheel','Aileron'] },
    quickTurn:        { adj: ['Agile','Snapping','Pivoting','Darting','Jinking','Dodging','Feinting','Evasive'],   noun: ['Pivot','Jink','Dodge','Feint','Sidestep','Cutback','Switchback','Snap'] },
    turretMode:       { adj: ['Entrenched','Fortified','Anchored','Locked','Planted','Rooted','Immovable','Dug-In'], noun: ['Turret','Bunker','Pillbox','Emplacement','Stronghold','Outpost','Redoubt','Bastion'] },
    serpentine:       { adj: ['Weaving','Zigzagging','Snaking','Undulating','Strafing','Sidestepping','Eluding','Slinking'], noun: ['Serpent','Zigzag','Slalom','Weave','Slink','Sway','Serpentine','Meander'] },
    panic:            { adj: ['Panicked','Frantic','Desperate','Hysterical','Manic','Crazed','Delirious','Unhinged'], noun: ['Panic','Frenzy','Hysteria','Rampage','Tantrum','Outburst','Meltdown','Breakdown'] },
    rapidFire:        { adj: ['Rapid','Staccato','Machinegun','Frantic','Blistering','Sustained','Unrelenting','Pounding'], noun: ['Barrage','Drumfire','Hailstorm','Onslaught','Blitz','Torrent','Deluge','Firestorm'] },
    spinOut:          { adj: ['Spiraling','Careening','Fishtailing','Drifting','Skidding','Swerving','Sliding','Veering'], noun: ['Spinout','Drift','Skid','Fishtail','Swerve','Slide','Whiplash','Tailspin'] },
    reverse:          { adj: ['Backward','Retreating','Reversed','Contrary','Inverse','Mirrored','Counter','Retrograde'], noun: ['Reversal','Retreat','Backtrack','Recoil','Regression','Fallback','Withdrawal','Rearguard'] },
    smokescreen:      { adj: ['Obscured','Hazy','Fogbound','Misty','Smoky','Veiled','Clouded','Murky'],           noun: ['Fog','Smokescreen','Haze','Mist','Murk','Smog','Cloud','Shroud'] },
    doubleTeam:       { adj: ['Mirrored','Cloned','Doubled','Split','Duplicated','Twinned','Copied','Echoed'],     noun: ['Doppelganger','Clone','Double','Decoy','Twin','Echo','Replica','Impostor'] },
    dumpDebris:       { adj: ['Littering','Dumping','Jettisoned','Trailing','Scattered','Discarded','Ejected','Strewn'], noun: ['Debris','Jetsam','Flotsam','Wake','Trail','Litter','Driftwood','Chaff'] },
    reflectorShields: { adj: ['Reflecting','Mirroring','Rebounding','Reversing','Glinting','Deflecting','Gleaming','Polished'], noun: ['Reflector','Mirror','Prism','Shield','Deflector','Lens','Facet','Surface'] },
    repulsor:         { adj: ['Repelling','Blasting','Shoving','Pulsing','Pushing','Expelling','Ejecting','Forceful'], noun: ['Repulsor','Pushback','Shockwave','Gust','Blast','Pulse','Thrust','Wave'] },
    shockPulse:       { adj: ['Pulsing','Shockwave','Radiating','Emanating','Rippling','Throbbing','Resonant','Quaking'], noun: ['Pulse','Shockwave','Ripple','Tremor','Quake','Resonance','Emanation','Vibration'] },
    mineField:        { adj: ['Trapped','Mined','Rigged','Laid','Lurking','Buried','Concealed','Scattered'],       noun: ['Minefield','Trap','Snare','Ambush','Pitfall','Deadfall','Hazard','Tripwire'] },
  },

  // ─── TEMPERAMENTS (temperament index 0–15) ────────────────
  temperament: [
    // 0: Berserker
    { adj: ['Berserk','Raging','Frenzied','Furious','Rabid','Wrathful','Bloodthirsty','Rampaging'],
      noun: ['Berserker','Fury','Rage','Rampage','Carnage','Havoc','Massacre','Mayhem'] },
    // 1: Sniper
    { adj: ['Patient','Calculated','Deliberate','Measured','Methodical','Precise','Surgical','Unhurried'],
      noun: ['Marksman','Deadeye','Sharpshooter','Sniper','Assassin','Hunter','Predator','Stalker'] },
    // 2: Soldier
    { adj: ['Disciplined','Regimented','Trained','Professional','Drilled','Ordered','Dutiful','Loyal'],
      noun: ['Trooper','Legionnaire','Infantry','Militia','Brigade','Battalion','Regiment','Platoon'] },
    // 3: Brawler
    { adj: ['Brawling','Scrappy','Bruising','Rough','Rowdy','Pugnacious','Belligerent','Combative'],
      noun: ['Brawler','Slugger','Bruiser','Scrapper','Pugilist','Boxer','Roughneck','Ruffian'] },
    // 4: Dancer
    { adj: ['Graceful','Elegant','Fluid','Flowing','Lithe','Nimble','Poised','Supple'],
      noun: ['Dancer','Waltz','Pirouette','Ballet','Tango','Minuet','Arabesque','Flourish'] },
    // 5: Tactician
    { adj: ['Strategic','Cunning','Shrewd','Calculating','Devious','Crafty','Scheming','Wily'],
      noun: ['Strategist','Gambit','Ploy','Scheme','Checkmate','Stratagem','Ruse','Endgame'] },
    // 6: Scrapper
    { adj: ['Tenacious','Stubborn','Relentless','Dogged','Gritty','Persistent','Unyielding','Scrappy'],
      noun: ['Underdog','Scrapper','Survivor','Fighter','Wildcat','Mongrel','Stray','Outcast'] },
    // 7: Bruiser
    { adj: ['Hulking','Towering','Crushing','Bludgeoning','Thundering','Stomping','Smashing','Walloping'],
      noun: ['Bruiser','Tank','Juggernaut','Enforcer','Brute','Ogre','Colossus','Heavyweight'] },
    // 8: Ghost
    { adj: ['Ghostly','Invisible','Vanishing','Fleeting','Intangible','Elusive','Untouchable','Incorporeal'],
      noun: ['Ghost','Phantom','Specter','Shadow','Wraith','Spirit','Shade','Haunt'] },
    // 9: Wildcard
    { adj: ['Chaotic','Unpredictable','Random','Volatile','Erratic','Unstable','Reckless','Impulsive'],
      noun: ['Wildcard','Joker','Maverick','Rogue','Rebel','Anarchist','Gamble','Dice'] },
    // 10: Bombardier
    { adj: ['Bombing','Carpet-Bombing','Pounding','Hammering','Raining','Shelling','Strafing','Pelting'],
      noun: ['Bombardier','Airstrike','Sortie','Barrage','Bombing','Salvo','Cannonade','Fusillade'] },
    // 11: Razor
    { adj: ['Lethal','Surgical','Deadly','Razor-Sharp','Fatal','Incisive','Keen','Merciless'],
      noun: ['Razor','Scalpel','Stiletto','Blade','Edge','Lancet','Rapier','Katana'] },
    // 12: Acrobat
    { adj: ['Nimble','Agile','Athletic','Acrobatic','Limber','Springy','Flexible','Light-Footed'],
      noun: ['Acrobat','Gymnast','Tumbler','Contortionist','Trapeze','Parkour','Stunt','Daredevil'] },
    // 13: Guardian
    { adj: ['Protective','Watchful','Vigilant','Steadfast','Stalwart','Devoted','Unwavering','Resolute'],
      noun: ['Guardian','Protector','Keeper','Defender','Sentinel','Custodian','Shield','Safeguard'] },
    // 14: Everyman
    { adj: ['Average','Common','Ordinary','Plain','Simple','Modest','Humble','Everyday'],
      noun: ['Nomad','Wanderer','Drifter','Traveler','Pilgrim','Vagabond','Rover','Ranger'] },
    // 15: Enforcer
    { adj: ['Imposing','Heavy-Handed','Authoritative','Dominating','Oppressive','Commanding','Overbearing','Intimidating'],
      noun: ['Enforcer','Warden','Overseer','Taskmaster','Dictator','Tyrant','Overlord','Commander'] },
  ],
};


// ─── SEEDED RNG (don't need to edit below this line) ────────

function _nameGenSeed(d, c, wk, pk, mk, t) {
  let h = 2166136261;
  h ^= d; h = Math.imul(h, 16777619); h = h >>> 0;
  h ^= c; h = Math.imul(h, 16777619); h = h >>> 0;
  h ^= t; h = Math.imul(h, 16777619); h = h >>> 0;
  const str = wk + ':' + pk + ':' + mk;
  for (let i = 0; i < str.length; i++) {
    h ^= str.charCodeAt(i);
    h = Math.imul(h, 16777619);
    h = h >>> 0;
  }
  return h;
}

function _nameGenRand(seed, iteration) {
  let h = seed + iteration * 374761393;
  h = Math.imul(h ^ (h >>> 15), 2246822519);
  h = Math.imul(h ^ (h >>> 13), 3266489917);
  h = (h ^ (h >>> 16)) >>> 0;
  return h;
}

// generateShipName(designIdx, colorIdx, weaponKey, passiveKey, maneuverKey, temperamentIdx)
function generateShipName(d, c, wk, pk, mk, t) {
  const seed = _nameGenSeed(d, c, wk, pk, mk, t);
  const pools = [
    SHIP_NAME_BANK.shape[d],
    SHIP_NAME_BANK.color[c],
    SHIP_NAME_BANK.weapon[wk],
    SHIP_NAME_BANK.passive[pk],
    SHIP_NAME_BANK.maneuver[mk],
    SHIP_NAME_BANK.temperament[t],
  ].filter(p => p);

  if (pools.length < 2) return 'Unknown Ship';

  const adjPoolIdx = _nameGenRand(seed, 0) % pools.length;
  const adjPool = pools[adjPoolIdx].adj;
  const adj = adjPool[_nameGenRand(seed, 1) % adjPool.length];

  let nounPoolIdx = _nameGenRand(seed, 2) % pools.length;
  if (nounPoolIdx === adjPoolIdx) nounPoolIdx = (nounPoolIdx + 1) % pools.length;
  const nounPool = pools[nounPoolIdx].noun;
  const noun = nounPool[_nameGenRand(seed, 3) % nounPool.length];

  return adj + ' ' + noun;
}

// ── END NAMEGEN ──

// ─── SHIP DATA ───
const PILOT_NAMES = ['FIGHTER','LEAF','BOMBER','ARROW','HEART','JET','MONSTER','EDGE','GHOST','POINT','TWISTER','SURVIVOR','HAWK','FRIGATE','CRESCENT','ENFORCER'];
const PILOT_COLORS = ['#ff4444','#44ff88','#4488ff','#ffaa22','#dd66bb','#44ffff','#88dd55','#ff6b4a','#aa44ff','#ffffff','#ffff44','#ff00ff','#55bbff','#ffcc00','#bbbbcc','#8844dd'];
const COLOR_NAMES = ['RED','GREEN','BLUE','ORANGE','PINK','CYAN','LIME','CORAL','PURPLE','WHITE','YELLOW','MAGENTA','SKY','GOLD','SILVER','VIOLET'];
function colorName(hex) { const i = PILOT_COLORS.indexOf(hex); return i >= 0 ? COLOR_NAMES[i] : ''; }

// ═══════════════════════════════════════════════════════════════
// STARCHIP PROCEDURAL NAME GENERATOR
// Each of 6 traits × 16 values = 96 entries, each with 8 adj + 8 nouns
// Seeded RNG ensures same card always gets same name
// ═══════════════════════════════════════════════════════════════

function colorIdx(hex) { return Math.max(0, PILOT_COLORS.indexOf(hex)); }


const SHIP_WEAPONS = ['alternating','chaotic','grenade','flamethrower','gatling','homing','snake','shotgun','scrap','basic','lightning','sniper','cyclone','drone','crossshot','concussive'];
const SHIP_PASSIVES = ['nitro','bouncyShot','stealth','incendiary','sparkDrive','shield','absorber','drillbore','obliterator','hitInvuln','stunShock','scope','iceRounds','flagship','gyro','override'];
const SHIP_MANEUVERS = ['rapidFire','reverse','mineField','smokescreen','doubleTeam','barrelRoll','repulsor','hyperSpeed','dumpDebris','reflectorShields','shockPulse','turretMode','spinOut','repulsor','panic','quickTurn'];
const WEAPON_NAMES = {
  alternating:'Alternator', chaotic:'Chaotic Burst', grenade:'Grenade', flamethrower:'Flamethrower',
  gatling:'Gatling Gun', homing:'Homing Missiles', snake:'Snake Shot', shotgun:'Shotgun',
  scrap:'Scrap Cannon', basic:'Basic Blaster', lightning:'Lightning Bolt', sniper:'Sniper Beam',
  cyclone:'Cyclone Shot', drone:'Drone Array', crossshot:'Cross-Shot', concussive:'Scatterburst'
};
const SHIP_SHAPES = [
  [[-.1,-.15],[-.45,-.4],[-.2,-.4],[0,-.5],[-.2,-.65],[-.7,-.65],[-.7,-.4],[-.4,0],[-.75,.4],[-.75,.6],[-.5,.6],[-.2,.6],[0,.5],[-.2,.4],[-.45,.4],[-.1,.15],[.45,.2],[.6,.15],[.65,.1],[.75,.1],[.925,0],[.75,-.1],[.65,-.1],[.6,-.15],[.45,-.2]],
  [[-1,0],[-.7,-.1],[-.75,-.4],[-.4,-.85],[-.25,-.7],[-.3,-.15],[0,-.5],[.3,-.25],[.2,0],[.5,-.15],[1,0],[.2,.45],[-.15,.25],[-.25,.65],[-.4,.8],[-.7,.45],[-.7,.1]],
  [[1,0],[.75,-.2],[-.15,-1],[-.05,-.4],[-.35,-.25],[-.55,0],[-.35,.25],[-.05,.45],[-.15,1],[.75,.2]],
  [[1,0],[-.8,-.7],[-.65,-.2],[.1,0],[-.65,.2],[-.8,.7]],
  [[-.7,-.65],[-.5,-.75],[.15,-.55],[1,0],[.15,.55],[-.5,.75],[-.7,.65],[-.75,.35],[-.5,.1],[-.35,0],[-.5,-.1],[-.75,-.4]],
  [[-.15,-.65],[-.8,-.65],[-.4,0],[-.8,.65],[-.2,.6],[-.45,.4],[1,0],[-.45,-.45]],
  [[.7,-.55],[.3,-1],[-.75,-.7],[-.85,-.2],[-.5,0],[-.85,.25],[-.7,.75],[.4,.95],[.65,.55],[.25,.7],[-.35,.5],[.2,.3],[1.1,0],[.2,-.25],[-.35,-.55],[.2,-.7]],
  [[.55,-.25],[.1,-.65],[.1,-.2],[-.65,-.9],[-.45,-.1],[-1,0],[-.45,.15],[-.65,.9],[.1,.15],[.1,.6],[.55,.2],[.6,.5],[1,0],[.6,-.6]],
  [[-.75,-.8],[.1,-.5],[-.85,-.2],[.2,0],[-.85,.25],[.1,.55],[-.75,.8],[.1,.75],[.6,.3],[1,0],[.6,-.3],[.1,-.7]],
  [[1,0],[-.7,-.65],[-.4,0],[-.7,.65]],
  [[1.2,0],[-.4,-.55],[-.6,-.45],[-.7,-.65],[-.2,-.2],[-.2,-.1],[-.85,0],[-.25,.05],[-.25,.2],[-.55,.4],[-.45,.65],[-.7,.65],[0,.3],[.15,-.05],[.25,.2],[.55,-.05],[.75,.25],[.85,.05]],
  [[.95,0],[-.9,-.7],[-.5,0],[-.9,.65],[.05,.3],[-.4,-.3],[.3,.15],[.15,-.2],[.6,.1]],
  [[.25,-.15],[.5,-.25],[1,0],[.5,.25],[.25,.15],[0,.25],[.2,.45],[.35,.75],[.1,.95],[-.5,.95],[0,.7],[-.25,.6],[-.1,.5],[-.4,.25],[-.6,.25],[-1.05,.35],[-1,0],[-1.05,-.4],[-.6,-.25],[-.4,-.25],[-.25,-.35],[-.05,-.5],[-.25,-.6],[0,-.7],[-.5,-.95],[.1,-.95],[.35,-.75],[.2,-.45],[0,-.25]],
  [[.99,0],[-.5,.85],[-.69,.55],[-.5,.35],[-.79,.4],[-.99,0],[-.79,-.4],[-.45,-.3],[-.69,-.55],[-.5,-.84]],
  [[.85,-.5],[.75,-.65],[.5,-.85],[.25,-.95],[0,-1],[-.25,-.95],[-.5,-.85],[-.75,-.65],[-.85,-.5],[-1,0],[-.85,.5],[-.65,.75],[-.25,.95],[0,1],[.25,.95],[.55,.85],[.85,.55],[-.25,.65],[-.2,.25],[-.3,.1],[.25,0],[-.3,-.1],[-.2,-.25],[-.25,-.6]],
  [[.35,-.3],[.3,-.5],[-.25,-.95],[-.5,-.85],[-.1,-.3],[-.3,-.2],[-1,-.35],[-.8,-.1],[-.1,0],[-.1,0],[-.8,.1],[-1,.35],[-.3,.2],[-.1,.3],[-.5,.85],[-.25,.95],[.3,.5],[.35,.3],[.95,.2],[1.05,0],[.95,-.2]],
];

function drawShipPreview(canvas, designIdx, color) {
  const size = canvas.width, ctx = canvas.getContext('2d');
  ctx.clearRect(0, 0, size, size);
  const verts = SHIP_SHAPES[designIdx] || SHIP_SHAPES[9];
  const r = size * 0.35;
  ctx.save(); ctx.translate(size/2, size/2);
  ctx.shadowColor = color; ctx.shadowBlur = size * 0.15;
  ctx.strokeStyle = color; ctx.lineWidth = Math.max(1.5, size * 0.06);
  ctx.fillStyle = color + '33'; ctx.lineJoin = 'round';
  ctx.beginPath(); ctx.moveTo(verts[0][0]*r, verts[0][1]*r);
  for (let i = 1; i < verts.length; i++) ctx.lineTo(verts[i][0]*r, verts[i][1]*r);
  ctx.closePath(); ctx.fill(); ctx.stroke(); ctx.restore();
}

// ─── STATE ───
let ws = null, myId = null, myShips = [], scanCooldown = false;

// ─── DOM ───
const joinScreen = document.getElementById('joinScreen');
const scanScreen = document.getElementById('scanScreen');
const matchScreen = document.getElementById('matchScreen');
const codeInput = document.getElementById('codeInput');
const nameInput = document.getElementById('nameInput');
const joinBtn = document.getElementById('joinBtn');
const errorMsg = document.getElementById('errorMsg');
const roomBadge = document.getElementById('roomBadge');
const playerNameDisplay = document.getElementById('playerNameDisplay');
const scanStatus = document.getElementById('scanStatus');
const shipList = document.getElementById('shipList');
const shipCount = document.getElementById('shipCount');
const video = document.getElementById('video');
const scanCanvas = document.getElementById('scanCanvas');

function showScreen(s) {
  [joinScreen, scanScreen, matchScreen].forEach(x => x.classList.remove('active'));
  s.classList.add('active');
}

function getServerUrl() {
  const l = location; return `${l.protocol === 'https:' ? 'wss:' : 'ws:'}//${l.host}`;
}

// ─── JOIN ───
joinBtn.onclick = () => {
  const code = codeInput.value.trim().toUpperCase();
  const name = nameInput.value.trim() || 'Player';
  if (code.length < 3) { errorMsg.textContent = 'Enter a valid room code'; return; }
  errorMsg.textContent = 'Connecting...'; joinBtn.disabled = true;
  ws = new WebSocket(getServerUrl());
  ws.onopen = () => { ws.send(JSON.stringify({ type: 'join_room', code, name })); };
  ws.onmessage = (e) => {
    const msg = JSON.parse(e.data);
    switch (msg.type) {
      case 'joined':
        myId = msg.id; roomBadge.textContent = msg.code;
        playerNameDisplay.textContent = nameInput.value.trim() || 'Player';
        showScreen(scanScreen); startCamera(); renderSavedFleet(); break;
      case 'error':
        errorMsg.textContent = msg.message; joinBtn.disabled = false; break;
      case 'scan_confirmed':
        scanStatus.textContent = 'StarChip registered!'; scanStatus.className = 'scan-status success';
        setTimeout(() => { scanStatus.textContent = 'Scan another StarChip'; scanStatus.className = 'scan-status'; }, 1500); break;
      case 'match_started': showScreen(matchScreen); break;
      case 'match_ended': myShips = []; renderShipList(); showScreen(scanScreen); renderSavedFleet(); break;
      case 'room_closed':
        errorMsg.textContent = 'Arena disconnected'; showScreen(joinScreen); joinBtn.disabled = false; break;
    }
  };
  ws.onerror = () => { errorMsg.textContent = 'Connection failed'; joinBtn.disabled = false; };
  ws.onclose = () => {
    if (scanScreen.classList.contains('active') || matchScreen.classList.contains('active')) {
      errorMsg.textContent = 'Disconnected from arena'; showScreen(joinScreen); joinBtn.disabled = false;
    }
  };
};
codeInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') joinBtn.click(); });

if ('serviceWorker' in navigator) navigator.serviceWorker.register('/sw.js').catch(() => {});

// ─── SAVED FLEET ───
const FLEET_KEY = 'starchip_saved_fleet';
const savedFleetSection = document.getElementById('savedFleetSection');
const savedFleetList = document.getElementById('savedFleetList');

function loadSavedFleet() {
  try { return JSON.parse(localStorage.getItem(FLEET_KEY)) || []; }
  catch { return []; }
}

function saveSavedFleet(fleet) {
  localStorage.setItem(FLEET_KEY, JSON.stringify(fleet));
}

function addToSavedFleet(ship) {
  const fleet = loadSavedFleet();
  // Don't save duplicates (same QR data)
  if (fleet.some(s => s._raw === ship._raw)) return;
  fleet.push({ d: ship.d, w: ship.w, c: ship.c, p: ship.p, m: ship.m, t: ship.t, _raw: ship._raw });
  saveSavedFleet(fleet);
  renderSavedFleet();
}

function renderSavedFleet() {
  const fleet = loadSavedFleet();
  savedFleetList.innerHTML = '';
  if (fleet.length === 0) { savedFleetSection.style.display = 'none'; return; }
  savedFleetSection.style.display = '';
  fleet.forEach((ship, i) => {
    const card = document.createElement('div'); card.className = 'saved-ship-card';
    // Check if already in current session
    const alreadyAdded = myShips.some(s => s._raw === ship._raw);
    if (alreadyAdded) card.classList.add('added');
    const canvas = document.createElement('canvas');
    canvas.width = 72; canvas.height = 72; canvas.className = 'ship-card-icon';
    drawShipPreview(canvas, ship.d, ship.c);
    const info = document.createElement('div'); info.className = 'ship-card-info';
    info.innerHTML = `<div class="ship-card-name" style="color:${ship.c}">${generateShipName(ship.d, colorIdx(ship.c), SHIP_WEAPONS[ship.w], SHIP_PASSIVES[ship.p], SHIP_MANEUVERS[ship.m], ship.t)}</div><div class="ship-card-detail">${WEAPON_NAMES[SHIP_WEAPONS[ship.w]] || 'Unknown'}</div>`;
    const addIcon = document.createElement('div'); addIcon.className = 'add-icon';
    addIcon.textContent = alreadyAdded ? '✓' : '+';
    card.onclick = () => {
      if (!ws || ws.readyState !== WebSocket.OPEN) return;
      if (myShips.some(s => s._raw === ship._raw)) return; // already in session
      const fullShip = { ...ship };
      fullShip._raw = ship._raw;
      myShips.push(fullShip);
      renderShipList();
      ws.send(JSON.stringify({ type: 'scan_ship', ship: { d: ship.d, w: ship.w, c: ship.c, p: ship.p, m: ship.m, t: ship.t } }));
      if (navigator.vibrate) navigator.vibrate(50);
      renderSavedFleet(); // update checkmarks
    };
    card.appendChild(canvas); card.appendChild(info); card.appendChild(addIcon);
    savedFleetList.appendChild(card);
  });
}

// ─── QR SCANNING ───
function startCamera() {
  navigator.mediaDevices.getUserMedia({
    video: { facingMode: 'environment', width: { ideal: 640 }, height: { ideal: 640 } }
  }).then(stream => { video.srcObject = stream; video.play(); requestAnimationFrame(scanFrame); })
    .catch(() => { scanStatus.textContent = 'Camera access denied'; });
}

function scanFrame() {
  if (!scanScreen.classList.contains('active')) return;
  if (video.readyState === video.HAVE_ENOUGH_DATA && !scanCooldown) {
    scanCanvas.width = video.videoWidth; scanCanvas.height = video.videoHeight;
    const ctx = scanCanvas.getContext('2d', { willReadFrequently: true });
    ctx.drawImage(video, 0, 0);
    const imageData = ctx.getImageData(0, 0, scanCanvas.width, scanCanvas.height);
    const code = jsQR(imageData.data, imageData.width, imageData.height, { inversionAttempts: 'dontInvert' });
    if (code && code.data) processQR(code.data);
  }
  requestAnimationFrame(scanFrame);
}

function parseQR(data) {
  const parts = data.split(':');
  if (parts[0] !== 'BBR' || parts.length < 6) return null;
  const d = parseInt(parts[1]), w = parseInt(parts[2]), c = parts[3];
  const p = parseInt(parts[4]), m = parseInt(parts[5]);
  const t = parts.length >= 7 ? parseInt(parts[6]) : d; // temperament defaults to design
  if (isNaN(d)||isNaN(w)||isNaN(p)||isNaN(m)||isNaN(t)) return null;
  if (d<0||d>15||w<0||w>15||p<0||p>15||m<0||m>15||t<0||t>15) return null;
  if (!/^[0-9a-fA-F]{6}$/.test(c)) return null;
  return { d, w, c: '#' + c, p, m, t };
}

function processQR(data) {
  const ship = parseQR(data); if (!ship) return;
  if (myShips.some(s => s._raw === data)) {
    scanStatus.textContent = 'Already scanned this StarChip'; scanStatus.className = 'scan-status';
    scanCooldown = true; setTimeout(() => { scanCooldown = false; }, 1500); return;
  }
  scanCooldown = true; setTimeout(() => { scanCooldown = false; }, 2000);
  ship._raw = data; myShips.push(ship); renderShipList();
  ws.send(JSON.stringify({ type: 'scan_ship', ship: { d: ship.d, w: ship.w, c: ship.c, p: ship.p, m: ship.m, t: ship.t } }));
  if (navigator.vibrate) navigator.vibrate(100);
  addToSavedFleet(ship);
  renderSavedFleet();
}

function renderShipList() {
  shipCount.textContent = myShips.length; shipList.innerHTML = '';
  myShips.forEach((ship, i) => {
    const card = document.createElement('div'); card.className = 'ship-card';
    const canvas = document.createElement('canvas');
    canvas.width = 72; canvas.height = 72; canvas.className = 'ship-card-icon';
    drawShipPreview(canvas, ship.d, ship.c);
    const info = document.createElement('div'); info.className = 'ship-card-info';
    info.innerHTML = `<div class="ship-card-name" style="color:${ship.c}">${generateShipName(ship.d, colorIdx(ship.c), SHIP_WEAPONS[ship.w], SHIP_PASSIVES[ship.p], SHIP_MANEUVERS[ship.m], ship.t)}</div><div class="ship-card-detail">${WEAPON_NAMES[SHIP_WEAPONS[ship.w]] || 'Unknown'}</div>`;
    const removeBtn = document.createElement('button'); removeBtn.className = 'ship-card-remove'; removeBtn.textContent = '✕';
    removeBtn.onclick = () => { myShips.splice(i, 1); renderShipList(); ws.send(JSON.stringify({ type: 'remove_ship', index: i })); renderSavedFleet(); };
    card.appendChild(canvas); card.appendChild(info); card.appendChild(removeBtn);
    shipList.appendChild(card);
  });
}

// ─── STARFIELD ───
const sf = document.getElementById('starfield');
const H = Math.max(innerHeight, 900);
for(let i=0;i<120;i++){const s=document.createElement('div');s.className='star';const z=Math.random()<.9?.5+Math.random()*1.5:2+Math.random()*2,b=.1+Math.random()*.4,p=Math.min(b+.1+Math.random()*.4,1);s.style.cssText=`width:${z}px;height:${z}px;left:${Math.random()*100}%;top:${Math.random()*H}px;--base-o:${b};--peak-o:${p};opacity:${b};animation:twinkle ${3+Math.random()*6}s ease-in-out ${Math.random()*4}s infinite;${z>2?`box-shadow:0 0 ${z*2}px ${z*.5}px rgba(200,220,255,.15);`:''}`;sf.appendChild(s)}
const ac=['#3a3a4a','#2a2a38','#4a4a58','#333345'];
for(let i=0;i<8;i++){const a=document.createElement('div');a.className='asteroid';const sz=15+Math.random()*40;a.style.cssText=`width:${sz}px;height:${sz*(.5+Math.random()*.5)}px;left:${Math.random()*100}%;top:${Math.random()*H}px;--rot:${Math.random()*360}deg;--dx:${-15+Math.random()*30}px;--dy:${-8+Math.random()*16}px;background:${ac[Math.floor(Math.random()*ac.length)]};border-radius:${30+Math.random()*40}% ${30+Math.random()*40}% ${30+Math.random()*40}% ${30+Math.random()*40}%;animation:drift ${30+Math.random()*40}s ease-in-out ${Math.random()*10}s infinite alternate;`;sf.appendChild(a)}
</script>
</body>
</html>
